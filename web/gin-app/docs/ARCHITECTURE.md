# アーキテクチャドキュメント

## 概要

このアプリケーションは、Clean Architecture の原則に基づいて設計されています。各レイヤーは明確に分離されており、テストしやすく、保守しやすい構造になっています。

## レイヤー構成

### 1. エントリーポイント層 (`cmd/api`)

アプリケーションのエントリーポイントです。以下の役割を持ちます:

- 設定の読み込み
- データベース接続の初期化
- ルーターのセットアップ
- サーバーの起動とグレースフルシャットダウン

### 2. ルーター層 (`internal/router`)

HTTPエンドポイントとハンドラーのマッピングを定義します:

- エンドポイントの定義
- ミドルウェアの適用
- ハンドラーの登録

### 3. ミドルウェア層 (`internal/middleware`)

HTTPリクエストの前処理・後処理を行います:

- **認証**: JWT トークンの検証
- **CORS**: クロスオリジンリクエストの処理
- **ロギング**: リクエスト/レスポンスのログ記録
- **レートリミット**: アクセス制限

### 4. ハンドラー層 (`internal/handlers`)

HTTPリクエストを受け取り、ビジネスロジックを実行してレスポンスを返します:

- リクエストのバリデーション
- ビジネスロジックの実行
- データベース操作
- レスポンスの生成

### 5. モデル層 (`internal/models`)

データベースのテーブル構造とビジネスドメインのデータ構造を定義します:

- データベースモデル（GORM タグ付き）
- リクエスト/レスポンスの構造体
- バリデーションルール

### 6. データベース層 (`internal/database`)

データベース接続とマイグレーションを管理します:

- データベース接続の確立
- 接続プールの設定
- 自動マイグレーション

### 7. 設定層 (`internal/config`)

アプリケーション全体の設定を管理します:

- 環境変数の読み込み
- デフォルト値の設定
- 設定のバリデーション

### 8. ユーティリティ層 (`internal/utils`)

汎用的なヘルパー関数を提供します:

- JWT 生成と検証
- レスポンスヘルパー
- バリデーション関数

## データフロー

```
HTTP Request
    ↓
Middleware (認証, CORS, ロギング等)
    ↓
Router (エンドポイントマッチング)
    ↓
Handler (リクエスト処理)
    ↓
Model (データ構造)
    ↓
Database (永続化)
    ↓
Handler (レスポンス生成)
    ↓
HTTP Response
```

## 依存関係

- **Gin**: HTTPフレームワーク
- **GORM**: ORM（オブジェクトリレーショナルマッピング）
- **JWT**: 認証トークン
- **bcrypt**: パスワードハッシュ化
- **PostgreSQL**: データベース

## 設計原則

1. **単一責任の原則**: 各パッケージは1つの責任のみを持つ
2. **依存性逆転の原則**: 抽象に依存し、具象に依存しない
3. **インターフェース分離の原則**: 必要なメソッドのみを公開
4. **開放閉鎖の原則**: 拡張に対して開き、修正に対して閉じる

## セキュリティ考慮事項

1. **認証**: JWT による認証
2. **認可**: ロールベースのアクセス制御
3. **パスワード**: bcrypt によるハッシュ化
4. **入力検証**: バリデーションによる検証
5. **レートリミット**: DDoS 対策
6. **CORS**: 信頼できるオリジンのみ許可

## スケーラビリティ

1. **データベース接続プール**: 効率的な接続管理
2. **ステートレス設計**: 水平スケーリングが容易
3. **ミドルウェアのモジュール化**: 機能の追加が容易
4. **設定の外部化**: 環境ごとの設定が容易

## 今後の拡張可能性

1. **キャッシュ層の追加**: Redis による高速化
2. **メッセージキューの導入**: 非同期処理
3. **マイクロサービス化**: サービスの分割
4. **監視とログ**: Prometheus, Grafana の導入
